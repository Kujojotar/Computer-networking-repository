# DNS

因特网主机的标识方式：**主机名**（www.google.com,www.yahoo.com)，**IP地址**。

IP地址：4个字节组成，具有严格的层次结构。

### 域名系统（Domain Name System，DNS）

DNS是什么？

一个由分层的DNS服务器实现的**分布式数据库**。一个使得主机能够**查询分布式数据库的应用层协议**。DNS服务器通常是运行在BIND软件的UNIX机器。DNS协议运行在UDP之上，使用**53**号端口。

![image-20210103221431402](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210103221431402.png)

DNS通常由其他应用层协议所使用，包括HTTP，SMTP和FTP，**将用户的主机名解析成IP地址**。



获取IP地址的过程

1.同一台用户主机上运行着DNS应用的客户端

2.浏览器从上述URL中抽取出主机名www.someschool.edu,并将这台主机名传给DNS应用上的客户端

3.DNS客户向DNS服务器发送一个包含主机名的请求。

4.DNS客户最终收到一份回答报文，其中含有对应于该主机名的IP地址。

5.一旦浏览器接收到来自于DNS的该IP地址，它就能够向位于该IP地址80端口的HTTP服务器进程发送一个TCP连接



DNS提供的其他服务

**主机别名**：有着复杂主机名的主机可能拥有一个或多个别名。这种情况下，某一主机名为**规范主机名**。而主机别名相对于规范主机名更容易记忆。应用程序可以**调用DNS来获取主机别名对应的规范主机名以及主机的IP地址**。

**邮件服务器别名**：电子邮件程序可以调用DNS对提供的邮件服务器别名进行解析，以**获取该主机的规范主机名以及IP地址**。

**负载分配**：DNS也用在冗余的服务器之间进行负载分配。繁忙的站点被冗余分配在多台服务器上，每台服务器均运行于不同的端系统上，每个都有着不同的IP地址。由于这些冗余的Web服务器，一个IP地址集合因此与同一个规范主机名相联系。DNS数据库中存储着这些IP地址集合。当客户对映射到某地址集合的名字发送一个DNS请求时，该服务器用IP地址的整个集合进行响应，但在每个回答中循环这些地址次序。因为客户通常总是向IP地址排在前面的服务器发送HTTP请求报文，所以DNS就在所有这些冗余的Web服务器之间循环分配了负载。DNS的循环同样可以用于邮件服务器，因此，多个邮件服务器可以拥有相同的别名。



DNS工作机制概述

​    假设某应用程序需要将**主机名**转化为**IP地址**。这些程序将调用DNS的客户端，并指明需要被转化的主机名。用户主机上的DNS接收到后，向网络中发送一个**DNS查询报文**。所有的DNS请求和回答报文使用**UDP**数据经端口**53**发送。经过若干毫秒到若干秒的时延后，用户主机上的DNS接收到一个提供所希望映射的DNS回答报文。这个映射结果则被传递到调用DNS的应用程序。因此，从用户主机调用应用程序的角度看，DNS是一个提供简单，直接服务的黑盒子。但事实上，实现这个黑盒子十分困难。它由分布于全球的大量DNS服务器以及定义了DNS服务器与查询主机通信方式的应用层协议组成。

![image-20210103224011964](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210103224011964.png)

![image-20210103224025688](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210103224025688.png)



1.分布式，层次数据库

  为了处理扩展性问题，DNS使用了大量的DNS服务器，它们以层次方式组织，并且分布于全世界范围内。**没有一台DNS服务器拥有因特网上所有主机的映射。相反，该映射分布于所有的DNS服务器上**。有三类DNS服务器：**根DNS服务器，顶级域DNS服务器，权威DNS服务器**。粗略地来说，用户先跟根服务器之一联系，它将返回顶级域名com的TLD服务器的IP地址。该客户则与这些TLD服务器之一联系，它将amazon.com返回权威服务器的IP地址。最后，该客户与amazon.com权威服务器之一取得联系，它将返回www.amazon.com的IP地址。

![image-20210104104551464](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210104104551464.png)

**根DNS服务器**：因特网有13个根DNS服务器，大部分位于北美，每台“服务器”实际上是一个**冗余服务器的网络**，以提供安全性和可靠性。到2011秋，共有247个根服务器。

**顶级域DNS服务器**：负责顶级域名如：**com，org，net，edu，gov**以及国家顶级域名如：**uk，fr，ca，jp**。

**权威DNS服务器**：在因特网上具有公共可访问主机（如Web服务器和邮件服务器）的每个组织机构必须提供公共可访问的DNS记录，这些记录将主机名字映射为IP地址。一个组织的权威DNS服务器收藏了这些记录。组织机构可选择实现自己的权威DNS服务器，也可选择将记录存储在某个服务提供商的一个权威DNS服务器中。

本地DNS服务器：严格讲并不属于此层次结构，但对DNS层次结构十分重要。每个ISP都有一个本地DNS服务器（也叫默认名字服务器）。主机与某个ISP连接时，该ISP提供一台主机的IP地址，该主机具有一台或多台其本地DNS服务器的IP地址，通过访问网络状态窗口，能够容易地确定你本地DNS服务器的IP地址。当主机发出DNS请求时，该请求被发往本地DNS服务器，它起到代理的作用，并将该请求转发到DNS服务器层次结构中。

![image-20210104110012819](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210104110012819.png)

![image-20210104110403556](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210104110403556.png)

**递归查询**：从cis.oply.edu到dns.poly.edu发出的查询时递归查询，因为该查询请求dns.poly.edu以自己的名义获得该映射。

**迭代查询**：后继的3个查询是，因为所有的回答都是直接返回给dns.poly.edu



**DNS缓存**

作用：**改善时延性能**，**减少在因特网中传输的DNS报文数量**。

原理：在一个DNS请求链中，某DNS服务器接收到一个DNS回答，它能将该回答中的信息**缓存**在本地存储器中。当另一个对相同主机名的查询到达时，该DNS服务器就能快速提供所需IP地址。由于主机和主机名IP映射并不是永久的，DNS服务器在**一段时间（通常两天）**将丢失缓存的信息。



DNS记录和报文

所有DNS服务器存储了**资源记录（Resource Record）**，RR提供了主机名到IP地址的映射。每个DNS回答报文包含了一条或多条资源记录。

资源记录是**四元组（Name，Value，Type，TTL）**

**TTL**是**记录生存时间**，决定了资源记录当从缓存中删去的时间。

**Name，Value**的意义取决于**Type**。

**Type=A：Name是主机名，Value是该主机名对应的IP地址。**

**Type=NS：Name是个域（如foo.com），而Value是个知道如何获取该域中主机IP地址的权威DNS服务器的主机名。这个记录用于沿着查询链来路由DNS查询。**

**Type=CHAME，Value是别名为Name的主机对应的规范主机名。该记录能够向查询的主机提供一个主机名对应的规范主机名。**

**Type=MX，则Value是个别名为Name的邮件服务器的规范主机名。公司允许邮件服务器和其他服务器可以使用相同的别名。**

![image-20210104112648704](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210104112648704.png)

如果一台DNS是用于特定主机名的权威DNS服务器，那么该DNS服务器会有一条包含该主机名的类型A记录（即使不是权威DNS服务器，也可能包含该主机名的类型A记录，参照DNS缓存）。如果不是用于某主机名的权威服务器，那么该服务器将包含一条类型的NS记录，该记录对应于包含主机名的域，它还将包含一条类型的A记录，该记录提供了在NS记录的Value字段中的DNS服务器的IP地址。





DNS报文

![image-20210104113359830](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210104113359830.png)

前十二字节为首部区域：

**标识符字段**：**16比特**的数，用于**标识该查询**。这个标识符会被复制到对查询的回答报文中，以便让客户用它来匹配发送的请求和接收到的回答/

**查询/回答标志**：指出报文是查询报文（0）还是回答报文（1）。

**权威标识**：如果用户所请求的名字是权威DNS服务器，1比特的权威标识将被置于回答报文中。

**希望递归标识**：客户希望进行递归查询。

**递归可用标识**：表示DNS服务器支持递归查询。

**4个有关数量的字段**：指出首部后4类数据区域出现的数量。



问题区域

1**.名字**字段，指出正在被查询的主机名字

2.**类型**字段：指出有关该名字的正被查询的问题类型，如A，MX...



回答区域

对最初请求的名字的资源记录，可以包含多条RR，看了上面就懂得



权威区域

包含了其他权威服务器的记录



附加区域

其他有帮助的记录。

![image-20210104114548904](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210104114548904.png)





向DNS数据库中插入记录

![image-20210104115215210](C:\Users\Jonny\AppData\Roaming\Typora\typora-user-images\image-20210104115215210.png)



DNS脆弱性

1.**分布式拒绝服务带宽洪泛攻击**：向每个DNS跟服务器发送大量的分组。解决方案：分组过滤器。

2.对TLD服务器发送大量分组。

3.**中间人攻击**：截取来自主机的请求并返回伪造的回答，攻击方法有效却难以实现。

4.**DDos攻击**，发送大量伪造目标主机地址的DNS请求，目前攻击方式成果有限。