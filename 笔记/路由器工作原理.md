# 路由器工作原理

![Router Architecture - Electronics Post](https://electronicspost.com/wp-content/uploads/2016/05/4.6.png)

输入端口：在路由器中执行入物理链路的物理层功能。还要与位于入链路远端的数据链路层交互来执行数据链路层功能。在输入端口执行**查找**功能，通过查询**转发表**决定路由器的输出端口，到达的分组通过路由器的交换结构转发到输出端口。控制分组从转发到输出端口的处理器。（此处端口指的是路由器的物理输入和物理输出接口）。

交换结构：交换结构将路由器的输入端口连接到他的输出端口。这种交换结构完全包含在路由器中，它是网络路由器中的网络。

输出端口：存储从交换结构接收的分组，并执行必要的链路层和物理层功能在输出链路上传输这些分组。当一条链路是双向时，输出端口和该链路的输入端口通常成对出现在同一线路卡上。

路由选择处理器：执行控制平面功能。传统路由器执行路由选择协议，维护路由选择表和关联链路状态的信息，并为该路由器计算转发表。SDN路由器中，路由选择处理器负责和远程控制器通信，目的是接收由远程控制器计算的转发表项，并在路由器的输入端口安装这些选项。路由选择处理器还执行网络管理功能。

重要的路由器组件（以汽车进入中转站为例）：入口道路和入口站对应于输入端口；环状交叉路对应于交换结构；环状交叉路出口道相当于输出端口。

#### 输入端口处理和基于目的地转发

![What's inside a router. Router architecture overview two key router  functions:  run routing algorithms/protocol (RIP, OSPF, BGP)  forwarding  datagrams. - ppt download](https://images.slideplayer.com/23/6848966/slides/slide_3.jpg)

线路端接相当于物理层，链路层处理相当于链路层。在这个地方，路由器使用转发表来查找输出端口，使得能够到达的分组能经过交换结构转发到该输出端口。转发表是根据路由选择处理器计算和更新的，或者使用转发表接收远程SDN控制器的内容。转发决策能在每个端口做出，无需基于每个分组调用集中式路由选择器，因此避免了集中式处理的瓶颈。



![我畫了40 張圖就是為了讓你搞懂計算機網絡層_程序員cxuan - MdEditor](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c6a1cb81acf41e8865fd9078fe4a35c~tplv-k3u1fbpfcp-zoom-1.image)

前缀匹配转发表

一个目的地址可能与不止一个前缀匹配，有多个匹配时，路由器使用最长前缀匹配规则。在该表中寻找最长的匹配项，并向最长前缀匹配相关联的接口转发分组。

尽管原理简单，但在实际运用中要设计G比特速率，纳秒级别。因此需要必须硬件执行查找，需要转发表使用快速算法。实践中使用**三态内容可寻址存储器**。



查找出某分组的输出端口后，可能存在交换结构被其他输入端口的分组占用的情况，，一个分组将进入输入端口处排队，并等待稍后被及时调度以通过交换结构。



查找过程的要求：1.出现物理层和链路层处理 2.必须检查报文的版本号，检验和寿命字段并将后两个字段重写。3.必须更新用于网络管理的计数器。



##### 交换

经内存交换技术：最简单，最早的路由器是计算机，在输入端口和输出端口之间通过CPU实现交换。分组到达输入端口，端口通过中断向路由选择处理器发出信号。于时分组被复制到处理器的内存。路由选择器从首部提出目的地址，再转发表找到合适的端口。将分组复制到输出端口的缓存中。不能同时转发两个分组。



经总线交换：输入端口经一根共享总线将分组直接传送到输出端口而不需要经过路由选择处理器的干预。输入端口先计划一个交换机的内部标签，指示本地输入端口，使分组在总线上传送和传输到输出端口。

![互联网络——基本的单极互联网络_olivia12344321的博客-CSDN博客](https://img-blog.csdnimg.cn/20200706094035556.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L29saXZpYTEyMzQ0MzIx,size_16,color_FFFFFF,t_70)

经互联网络交换：纵横式交换机是2N个总线组成的互联网络，它连接N个输入端口和N个输出端口。当某分组到达端口A的时候需要转发到端口Y时，交换机控制器闭合总线A和Y交叉部位的交叉点，然后端口A在其总线上发送该分组，该分组仅被Y接收。纵横式交换机是非阻塞的，即只要没有其他分组当前被转发到该输出端口，转发到输出端口的分组将不会被到达输出端口的分组阻塞。然而，如果来自两个不同的输入端口的两个分组其目的地为相同的输出端口，则一个分组必须在输入端等待，因为在某时刻给定总线只能发送一个分组。



#### 输出端口处理

![路由器你竟然是这样的... - 知乎](https://pic4.zhimg.com/80/v2-669012e16c4404125d7dc626a2d0a583_1440w.jpg)







